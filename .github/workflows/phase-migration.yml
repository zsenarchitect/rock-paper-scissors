name: ðŸ”„ Phase Migration Workflow

on:
  workflow_dispatch:
    inputs:
      phase:
        description: 'Migration phase'
        required: true
        type: choice
        options:
        - phase1-to-typescript
        - phase1-to-rust
        - phase1-to-python
        - phase2-to-microservices
        - full-migration
      dry-run:
        description: 'Dry run (no actual changes)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  RUST_VERSION: '1.70'

jobs:
  # Phase 1 to TypeScript migration
  migrate-to-typescript:
    name: ðŸ”§ Migrate to TypeScript
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'phase1-to-typescript'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ðŸ“¦ Install TypeScript
      run: |
        npm install -g typescript @types/node
        npm init -y
        npm install --save-dev typescript @types/node ts-node
        
    - name: ðŸ”§ Setup TypeScript configuration
      run: |
        cat > tsconfig.json << 'EOF'
        {
          "compilerOptions": {
            "target": "ES2020",
            "module": "ES2020",
            "moduleResolution": "node",
            "strict": true,
            "esModuleInterop": true,
            "skipLibCheck": true,
            "forceConsistentCasingInFileNames": true,
            "outDir": "./dist",
            "rootDir": "./docs/js",
            "declaration": true,
            "sourceMap": true
          },
          "include": ["docs/js/**/*"],
          "exclude": ["node_modules", "dist", "temp", "DEBUG"]
        }
        EOF
        
    - name: ðŸ”„ Convert JavaScript to TypeScript
      if: ${{ !github.event.inputs.dry-run }}
      run: |
        cd docs/js
        find . -name "*.js" -exec sh -c 'mv "$1" "${1%.js}.ts"' _ {} \;
        echo "JavaScript files converted to TypeScript"
        
    - name: ðŸ§ª Test TypeScript compilation
      run: |
        if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
          echo "ðŸ” Dry run: Would convert JavaScript files to TypeScript"
          find docs/js -name "*.js" | head -5
        else
          npx tsc --noEmit
          echo "âœ… TypeScript compilation successful"
        fi

  # Phase 1 to Rust migration
  migrate-to-rust:
    name: ðŸ¦€ Migrate to Rust
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'phase1-to-rust'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        components: rustfmt, clippy
        
    - name: ðŸ—ï¸ Create Rust project structure
      if: ${{ !github.event.inputs.dry-run }}
      run: |
        mkdir -p backend/src/{api,simulation,models}
        cat > backend/Cargo.toml << 'EOF'
        [package]
        name = "rock-paper-scissors-backend"
        version = "0.1.0"
        edition = "2021"
        
        [dependencies]
        actix-web = "4.0"
        serde = { version = "1.0", features = ["derive"] }
        serde_json = "1.0"
        tokio = { version = "1.0", features = ["full"] }
        EOF
        
    - name: ðŸ§ª Test Rust setup
      run: |
        if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
          echo "ðŸ” Dry run: Would create Rust backend structure"
        else
          cd backend
          cargo check
          echo "âœ… Rust project setup successful"
        fi

  # Phase 1 to Python migration
  migrate-to-python:
    name: ðŸ Migrate to Python
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'phase1-to-python'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”„ Enhance Python AI training
      if: ${{ !github.event.inputs.dry-run }}
      run: |
        # Enhance existing Python modules
        python -c "
        import sys
        sys.path.append('.')
        from ai_training.models.genetic_algorithm import GeneticAlgorithm
        from ai_training.models.neural_network import NeuralNetwork
        
        # Test enhanced functionality
        ga = GeneticAlgorithm()
        nn = NeuralNetwork()
        print('âœ… Python AI modules enhanced')
        "
        
    - name: ðŸ§ª Test Python migration
      run: |
        if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
          echo "ðŸ” Dry run: Would enhance Python AI training modules"
        else
          python ai_training/scripts/train_model.py --test-mode
          echo "âœ… Python migration successful"
        fi

  # Phase 2 to microservices migration
  migrate-to-microservices:
    name: ðŸ—ï¸ Migrate to Microservices
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'phase2-to-microservices'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker
      run: |
        # Check if Docker is available
        docker --version || echo "Docker not available"
        
    - name: ðŸ—ï¸ Create microservices structure
      if: ${{ !github.event.inputs.dry-run }}
      run: |
        mkdir -p services/{game-engine,ai-training,analytics,user-management}
        mkdir -p infrastructure/{docker,kubernetes}
        
        # Create basic Docker Compose for microservices
        cat > docker-compose.microservices.yml << 'EOF'
        version: '3.8'
        services:
          game-engine:
            build: ./services/game-engine
            ports:
              - "8001:8001"
              
          ai-training:
            build: ./services/ai-training
            ports:
              - "8002:8002"
              
          analytics:
            build: ./services/analytics
            ports:
              - "8003:8003"
              
          user-management:
            build: ./services/user-management
            ports:
              - "8004:8004"
        EOF
        
    - name: ðŸ§ª Test microservices setup
      run: |
        if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
          echo "ðŸ” Dry run: Would create microservices architecture"
        else
          echo "âœ… Microservices structure created"
        fi

  # Full migration (all phases)
  full-migration:
    name: ðŸš€ Full Migration
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'full-migration'
    needs: [migrate-to-typescript, migrate-to-rust, migrate-to-python, migrate-to-microservices]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”„ Run full migration
      run: |
        echo "ðŸš€ Running full migration..."
        echo "Phase 1 â†’ TypeScript: ${{ needs.migrate-to-typescript.result }}"
        echo "Phase 1 â†’ Rust: ${{ needs.migrate-to-rust.result }}"
        echo "Phase 1 â†’ Python: ${{ needs.migrate-to-python.result }}"
        echo "Phase 2 â†’ Microservices: ${{ needs.migrate-to-microservices.result }}"
        
        if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
          echo "ðŸ” Dry run: Would perform full migration"
        else
          echo "âœ… Full migration completed"
        fi

  # Migration validation
  validate-migration:
    name: âœ… Validate Migration
    runs-on: ubuntu-latest
    needs: [migrate-to-typescript, migrate-to-rust, migrate-to-python, migrate-to-microservices]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Validate migration results
      run: |
        echo "Migration validation results:"
        echo "TypeScript: ${{ needs.migrate-to-typescript.result }}"
        echo "Rust: ${{ needs.migrate-to-rust.result }}"
        echo "Python: ${{ needs.migrate-to-python.result }}"
        echo "Microservices: ${{ needs.migrate-to-microservices.result }}"
        
        # Check if all migrations succeeded
        if [ "${{ needs.migrate-to-typescript.result }}" = "success" ] && \
           [ "${{ needs.migrate-to-rust.result }}" = "success" ] && \
           [ "${{ needs.migrate-to-python.result }}" = "success" ] && \
           [ "${{ needs.migrate-to-microservices.result }}" = "success" ]; then
          echo "ðŸŽ‰ All migrations completed successfully!"
        else
          echo "âš ï¸ Some migrations failed or were skipped"
        fi
